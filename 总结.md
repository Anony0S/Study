# 图片上传相关

## 基于Element-ui上传组件二次封装

- **限制格式**
  1. `accept：`对文件上传控件中可选择的文件类型进行限制
     - ![image-20221112094830164](C:\Users\Admin\Documents\Typora\总结.assets\image-20221112094830164.png)
     - [唯一文件类型说明符](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/input/file#%E5%94%AF%E4%B8%80%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B%E8%AF%B4%E6%98%8E%E7%AC%A6)
  2. `before-upload`上传前钩子函数，拿到上传前文件，通过文件`type`属性获取文件类型进行判断
     - ![image-20221112101536089](C:\Users\Admin\Documents\Typora\总结.assets\image-20221112101536089.png)

- **限制大小**

  - 原理同上，通过`before-upload`拿到上传文件，通过文件`size`属性获取文件大小进行判断

    ![image-20221112101716883](C:\Users\Admin\Documents\Typora\总结.assets\image-20221112101716883.png)

- **实现对上传图片的宽高进行限制**

  - 通过`Image()`构造函数创建`img`实例（相当于创建了一个`img` `DOM`元素）

  - 设置`img`的`src`为上传的图片

  - 使用`img.onload()`函数，在图片加载完成后获取到图片的宽高（必须在此函数中获取宽高，大概是因为读取图片为异步行为？），对宽高进行判断

  - 核心代码

    - ```js
      beforeAvatarUpload(file) {
                  // === 限制格式和大小
                  const isTypeTrue = /^image\/(jpeg|png|jpg)$/.test(file.type);
                  const isLt = file.size / 1024 / 1024 < this.imgSize;
                  if (!isTypeTrue) {
                      this.$message.error("请上传指定格式图片");
                      return false;
                  }
                  if (!isLt) {
                      this.$message.error(`请上传大小在${this.imgSize}M内的图片`);
                      return false;
                  }
                  // === 限制尺寸
                  let _this = this;
                  const isSize = new Promise(function (resolve, reject) {
                      let width = _this.width; // 限制图片尺寸
                      let height = _this.height;
                      // URL对象是硬盘（SD卡等）指向文件的一个路径
                      let _URL = window.URL || window.webkitURL;
                      let img = new Image();
                      //设置src才能取到图片宽高等属性
                      img.src = _URL.createObjectURL(file);
                      img.onload = function () {
                          console.log("Width:", img.width, "height:", img.height);
                          let valid = img.width <= width && img.height <= height;
                          // let valid = true;
                          valid ? resolve(img.src) : reject();
                      };
                  }).then(
                      (res) => {
                          _this.imageUrl = res; // 图片回显
                          return file;
                      },
                      () => {
                          _this.$message.error(`上传图片与要求尺寸不符,请重新上传`);
                          return Promise.reject();
                      }
                  );
                  return isTypeTrue && isLt && isSize;
              },
      ```



## 基于Element-ui上传组件实现图片上传压缩

> 实现方法写在`before-upload`属性（上传文件之前的钩子）中，即上传前进行图片的压缩操作

- **实现原理**

  1. 通过`canvas`画布将上传的图片绘制出来

  2. 再通过`canvas.toDataURL()`方法对图片进行压缩（核心）

     此方法获取到的图片为Base64格式

  3. 上传图片到后端可转换为Blob或其他格式进行上传

- **核心代码**

  ```js
  beforeAvatarUpload(file) {
      const fileSize = file.size / 1024 / 1024;
      console.log("图片原始大小：", fileSize.toFixed(2) + "M");
      // 创建画布
      let canvas = document.createElement("canvas");
      let context = canvas.getContext("2d");
      // 创建新的图片对象
      let img = new Image();
      // 指定图片的DataURL(base64格式/此处使用Blob)
      img.src = URL.createObjectURL(file);
      img.onload = () => {
          // 指定画布大小 =》 这里设置为原大小
          canvas.width = img.width;
          canvas.height = img.height;
          // 绘制画布
          context.drawImage(img, 0, 0);
          // 核心：将绘制完成的图片转化为base64，并进行压缩
          this.imageUrl = canvas.toDataURL(file.type, 0.5);
      };
      return false;
  },
  ```



>  参考链接:
>
> [前端图片压缩上传（压缩篇）：可能是最适合小白的前端图片压缩文章了](https://juejin.cn/post/7081619017365979149)
>
> [Vue使用vant上传组件上传图片并对大图压缩](https://juejin.cn/post/6844903742416879630)
>
> [一个项目小亮点---图片压缩上传](https://juejin.cn/post/7081619017365979149)
>
> [[1.3万字]玩转前端二进制](https://juejin.cn/post/6846687590783909902)



# 地图相关
